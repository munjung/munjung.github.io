---
layout: post
title: 임계구역 정의 및 해결 조건
subtitle: 임계구역이란?
tags: [운영체제]
---

얼마전 중간고사 시즌이었다. 그 중 한 과목이 운영체제인데 프로세스 동기화를 배우며 임계구역 해결 부분을 주의깊게 봤다. 블로그도 열심히 찾아보며 이해했는데 정작 시험에 나오진 않았다.ㅎㅎ 어떻게 동작하는지에 대해 물어보길 바랬는데 그냥 알고리즘 암기식으로 나왔다. 그래서 이대로 넘어가긴 아쉬워서 나름 공부한 것을 바탕으로 정리해보려고 한다!


## 임계구역(Critical Section)

프로세스 동기화에서 반드시 알아야 할 것은 바로 임계구역이다. 임계구역이란 공유 자원의 접근 순서에 따라 실행 결과가 달라지는 프로그램의 영역을 의미한다. 쉽게 예를 들면 주방에서의 믹서기를 생각하면 된다. 만약 하나의 재료만 믹서기를 사용하면 아무런 문제가 없다. 하지만 재료들을 이것 저것 한번에 넣어버리면 엉망이 되는 것이다. 따라서 믹서기는 주방에서의 임계구역이라고 할 수 있다. 이렇듯 임계구역에서는 다수의 프로세스들이 접근할 수는 있지만 프로세스들이 동시에 작업을 하면 문제가 생긴다.

![critical_section](/img/190429/190429_img_1.jpeg)  

위의 그림으로 살펴보면 생산자-소비자 문제 코드는 실행 순서에 따라 결과가 달라진다. 생산자는 수를 증가시켜가며 물건을 채우고 소비자는 생산자를 쫓아가며 물건을 소비하게 된다. 그런데 만약 생산자 코드와 소비자 코드가 동시에 실행되게 된다면 sum의 값이 계속해서 바뀌기 때문에 문제가 발생하게 된다. 즉, 임계구역은 `둘 이상의 프로세스가 공유할 수 없는 영역`인 셈이다. 그렇기 때문에 어떤 프로세스가 임계구역에 들어가면 다른 프로세스는 임계구역 밖에서 기다려야 하며 임계구역의 프로세스가 나와야 들어갈 수 있다. 대표적으로 `공유변수`가 임계영역에 해당한다. 그 뿐만 아니라 하드웨어 자원도 임계구역이 될 수 있다.  


임계구역 문제를 해결해야 하는데 **임계구역 해결 조건** 으로는 3가지가 존재한다.

## 상호 배제(Mutual Exclusion)
상호배제란 쉽게 말하면 프로세스간 자원이 서로 배타적이어야 한다는 것이다. 한 프로세스가 자원을 사용하고 있다면(임계구역에 들어가면) 다른 프로세스는 자원을 사용할 수 없어야 한다(임계구역에 들어갈 수 없다). 반대의 경우도 마찬가지이다. 즉 한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 `배타적인 자원`이어야 한다.

## 한정 대기(Bounded Waiting)
어떤 프로세스도 자원을 사용하기 위해 무한 대기하지 않아야 한다. 즉 `임계구역에 유한한 시간 내에 접근해야 한다`는 것이다. 무한한 시간동안 아무런 프로세스도 임계구역에 접근하지 못하는 경우가 발생해서는 안된다.

## 진행의 융통성(Progress Flexibility)
임계구역에 진입할 때는 어떤 프로세스가 들어갈 지 유한 시간 내에 결정이 일어나야 한다. 또한 한 프로세스가 다른 프로세스의 진행을 방해해서는 안된다.


임계구역 문제 해결을 위한 단순한 방법은 `전역변수 lock`을 이용하는 방법이 있다. 임계 구역에 진입하려는 프로세스는 진입 전 lock을 true로 설정하고 임계구역에서 빠져나오면 값을 false로 바꾸는 것이다. 하지만 전역 변수로 잠금을 구현하면 문제가 발생하게 된다.

![global_varible_problem_1](/img/190429/190429_img_2.jpeg)  

위의 그림은 `상호 배제가 보장되지 못하는 경우`이다. 프로세스 P1은 1번 문장을 실행한다. 현재 lock이 false인 상태이기 때문에 빠져나와서 다음 문장을 실행해야 하지만, 만약 P1이 할당 받은 CPU 시간이 지나 타임아웃이 발생하게 되면 프로세스 P2의 차례로 넘어가게 된다. 그러면 아직 lock은 false이기 때문에 2번 문장 또한 바로 빠져나오게 되고 P1과 P2 모두 lock이 true가 되면서 결국 두 프로세스 모두 임계구역에 진입하게 되는 문제가 발생하게 된다.

![global_varible_problem_2](/img/190429/190429_img_3.jpeg)  

다음으로 `한정 대기가 보장되지 못하는 경우`이다. 공유 변수가 2개로 늘어났고 모두 false인 상태이다. 먼저 P1이 1번 문장을 실행해 lock1이 true가 된다. 그런데 만약 위의 경우와 같이 타임아웃이 발생하여 P2로 넘어가게 되면 lock2 또한 true가 된다. 그렇게 되면 2개의 공유 변수 모두 true가 되면서 3,4번 문장의 while문제 빠져 서로 무한대기 하게 된다.

![global_varible_problem_3](/img/190429/190429_img_4.jpeg)  
상호 배제와 한정 대기는 보장되지만 `진행의 융통성 조건을 충족하지 못하는 경우`이다. 현재 공유 변수 lock이 1인 상태이기 때문에 프로세스 P1이 먼저 실행되면 while문에서 바로 빠져나오게 된다. 만약에 이전처럼 타임아웃이 발생해서 P2로 넘어간다고 해도 lock은 여전히 1이기 때문에 P2의 while문에서 계속 머무르게 된다. P1은 임계구역에 진입하게 되고 나오면서 lock을 2로 바꾼다. lock이 2로 바뀌는 순간 P2의 while 조건이 깨지기 때문에 그 뒤에 P2도 임계구역에 진입할 수 있다. 임계구역에 두 프로세스가 동시에 들어갈 수 없고 무한히 대기 하지 않기 때문에 괜찮은 것 같지만 진행에 융통성이 없다는 문제가 있다. `반드시 번갈아서 실행`되어야 하기 때문이다. 위의 코드를 예를 들면 P2는 무조건 P1이 선행되어야만 임계구역에 진입할 수 있다는 한계가 있다.


상호배제 문제를 해결하기 위한 `하드웨어적인 방법`으로는 **검사와 지정(Test&Set)** 기법과 **SWAP** 명령어가 있다. 사용하기 쉽고 여러 개의 임계구역에서 사용할 수 있다는 장점이 있지만 바쁜 대기(Busy-Waiting)과 교착 상태가 발생할 수 있다는 단점이 존재한다.

이 밖에 임계구역 해결상호배제 문제를 해결하기 위한 몇가지 알고리즘이 존재한다.  
그것은 [다음포스팅](/2019-05-01-pterson_algorithm/)에 정리해보도록 하겠다.
